<!-- src/app/features/notas-fiscais/notas-fiscais-admin/notas-fiscais-empresa.component.html -->
<p-toast />
<p-confirmdialog>
  <ng-template let-message let-onAccept="onAccept" let-onReject="onReject">
    <div class="flex flex-col items-center w-full gap-4 border-b   p-6">
      <i [ngClass]="message.icon || 'pi pi-info-circle'"></i>
      <p class="text-center text-lg">{{ message.message }}</p>
    </div>
  </ng-template>
</p-confirmdialog>

<app-visualizar-nota-dialog [(visible)]="modalVisualizarVisivel" [nota]="notaSelecionadaClienteAdmin"
  (aprovar)="emitirNota($event)" (recusar)="recusarNota($event)"
  [loadingAprovar]="estaCarregando(notaSelecionadaClienteAdmin?.id ?? 0)"
  [loadingRecusar]="estaCarregando(notaSelecionadaClienteAdmin?.id ?? 0)" />
<app-recusar-nota-dialog [(visible)]="modalRecusarVisivel" (recusar)="onRecusarConfirmado($event)" />

<!-- Header Section -->
<div class="flex align-items-center gap-3 mb-4 p-3">
  <div class="icon-wrapper border-circle p-3  shadow-1 flex align-items-center justify-content-center">
    <i class="pi pi-building text-primary text-5xl"></i>
  </div>
  <div class="flex flex-column">
    <h1 class="m-0 text-5xl font-bold text-900">Notas Fiscais - Admin</h1>
    <p class="text-500 mt-1 mb-0">Gerencie todas as notas fiscais da empresa</p>
  </div>
</div>

<!-- Loading -->
<div *ngIf="loadingTabela" class="mb-3">
  <p-progressBar mode="indeterminate" [style]="{ height: '6px' }"></p-progressBar>
</div>

<!-- Main Card -->
<div *ngIf="!loadingTabela" class=" p-4 border-round-2xl shadow-1">

  <!-- Toolbar -->
  <div class="flex justify-content-between align-items-center mb-4">
    <div class="flex align-items-center gap-2 flex-wrap">
      <p-button icon="pi pi-filter-slash" [rounded]="true" [text]="true" (click)="clearFilters()" pTooltip="Limpar filtros"
        tooltipPosition="top" />

      <!-- Campo de pesquisa -->
      <p-iconField iconPosition="left">
        <p-inputIcon>
          <i class="pi pi-search"></i>
        </p-inputIcon>
        <input pInputText type="text"   [(ngModel)]="globalFilterValue" (input)="onGlobalFilter($event)" placeholder="Pesquisar notas..."
          class="w-20rem border-round-2xl" />
      </p-iconField>

      <!-- Dropdown de status -->
      <p-select [options]="statusOptions" [(ngModel)]="selectedStatus" (onChange)="onStatusFilter()"
        placeholder="Filtrar por status" styleClass="border-round-2xl w-15rem" [showClear]="true">

        <!-- Template para o item SELECIONADO (no campo) -->
        <ng-template pTemplate="selectedItem" let-item>
          <p-tag *ngIf="item; else placeholder" [value]="item.label" [severity]="item.severity"
            styleClass="border-round-2xl px-2 py-1 text-xs font-medium" />
          <ng-template #placeholder>
            <span class="text-500">Filtrar por status</span>
          </ng-template>
        </ng-template>

        <!-- Template para os ITENS da lista dropdown -->
        <ng-template pTemplate="item" let-item>
          <p-tag [value]="item.label" [severity]="item.severity"
            styleClass="w-full justify-content-start px-3 py-2 border-round-2xl text-sm font-medium" />
        </ng-template>
      </p-select>
    </div>
  </div>

  <!-- Table -->
  <p-table #dt [value]="notas" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[10, 25, 50]"
    [showCurrentPageReport]="true" currentPageReportTemplate="Exibindo {first} a {last} de {totalRecords} registros"
    responsiveLayout="scroll" dataKey="id" [globalFilterFields]="[
      'usuario.cnpj_cpf',
      'usuario.razao_social',
      'cliente.cpf_cnpj',
      'cliente.razao_social',
      'valor_total',
      'status_id',
      'data_criacao',
      'aliquota'
    ]" styleClass="p-datatable-sm">

    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="usuario.cnpj_cpf" class="border-bottom-1  p-3" style="width: 12%">
          <div class="flex align-items-center gap-2">
            <i class="pi pi-id-card text-primary"></i>
            <span class="text-900">Sol. CPF/CNPJ</span>
            <p-sortIcon field="usuario.cnpj_cpf" />
          </div>
        </th>

        <th pSortableColumn="usuario.razao_social" class="border-bottom-1  p-3" style="width: 14%">
          <div class="flex align-items-center gap-2">
            <i class="pi pi-building text-primary"></i>
            <span class="text-900">Sol. Razão Social</span>
            <p-sortIcon field="usuario.razao_social" />
          </div>
        </th>

        <th pSortableColumn="cliente.cpf_cnpj" class="border-bottom-1  p-3" style="width: 12%">
          <div class="flex align-items-center gap-2">
            <i class="pi pi-id-card text-primary"></i>
            <span class="text-900">CPF/CNPJ</span>
            <p-sortIcon field="cliente.cpf_cnpj" />
          </div>
        </th>

        <th pSortableColumn="cliente.razao_social" class="border-bottom-1  p-3" style="width: 14%">
          <div class="flex align-items-center gap-2">
            <i class="pi pi-building text-primary"></i>
            <span class="text-900">Razão Social</span>
            <p-sortIcon field="cliente.razao_social" />
          </div>
        </th>

        <th pSortableColumn="valor_total" class="border-bottom-1  p-3 text-center" style="width: 10%">
          <div class="flex align-items-center gap-2 justify-content-center">
            <i class="pi pi-money-bill text-primary"></i>
            <span class="text-900">Valor</span>
            <p-sortIcon field="valor_total" />
          </div>
        </th>

        <th pSortableColumn="aliquota" class="border-bottom-1  p-3 text-center" style="width: 8%">
          <div class="flex align-items-center gap-2 justify-content-center">
            <i class="pi pi-percentage text-primary"></i>
            <span class="text-900">Alíq.</span>
            <p-sortIcon field="aliquota" />
          </div>
        </th>

        <th pSortableColumn="status_id" class="border-bottom-1  p-3 text-center" style="width: 12%">
          <div class="flex align-items-center gap-2 justify-content-center">
            <i class="pi pi-info-circle text-primary"></i>
            <span class="text-900">Status</span>
            <p-sortIcon field="status_id" />
          </div>
        </th>

        <th pSortableColumn="data_criacao" class="border-bottom-1  p-3 text-center" style="width: 12%">
          <div class="flex align-items-center gap-2 justify-content-center">
            <i class="pi pi-calendar text-primary"></i>
            <span class="text-900">Solicitação</span>
            <p-sortIcon field="data_criacao" />
          </div>
        </th>

        <th class="border-bottom-1  p-3 text-center" style="width: 6%">
          <div class="flex align-items-center gap-2 justify-content-center">
            <i class="pi pi-cog text-primary"></i>
            <span class="text-900">Ações</span>
          </div>
        </th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-nota>
      <tr class="border-bottom-1  transition-duration-150">
        <td class="p-3">
          <p class="text-900 m-0">
            {{ nota.usuario.cnpj_cpf | maskCpfCnpj }}
          </p>
        </td>

        <td class="p-3">
          <p class="text-900 m-0 truncate" style="max-width: 180px">
            {{ nota.usuario.razao_social || '—' }}
          </p>
        </td>

        <td class="p-3">
          <p class="text-900 m-0">
            {{ nota.cliente.cpf_cnpj | maskCpfCnpj }}
          </p>
        </td>

        <td class="p-3">
          <p class="text-900 m-0 truncate" style="max-width: 180px">
            {{ nota.cliente.razao_social || '—' }}
          </p>
        </td>

        <td class="p-3 text-center">
          <p class="text-900 m-0">
            {{ nota.valor_total | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}
          </p>
        </td>

        <td class="p-3 text-center">
          <p class="text-900 m-0">
            {{ nota.aliquota || 'N/A' }}%
          </p>
        </td>

        <td class="p-3 text-center">
          <div class="flex justify-content-center">
            <p-tag [value]="getStatusLabel(nota.status_id)" [severity]="getStatusSeverity(nota.status_id)"
              styleClass="w-full justify-content-center" />
          </div>
        </td>

        <td class="p-3 text-center">
          <p class="text-900 m-0">
            {{ nota.data_criacao | date: 'dd/MM/yyyy - HH:mm' }}
          </p>
        </td>

        <td class="p-3 text-center">
          <div class="flex justify-content-center gap-1">
            <!-- Visualizar (sempre disponível) -->
            <p-button icon="pi pi-eye" [rounded]="true" [text]="true" severity="secondary"
              (click)="visualizarNota(nota)" pTooltip="Visualizar" tooltipPosition="top" styleClass="w-2rem h-2rem" />

            <!-- Aprovar/Recusar apenas se estiver "Aguardando Validação" (status_id === 1) -->
            <ng-container *ngIf="nota.status_id === 1">
              <p-button icon="pi pi-check" [rounded]="true" [text]="true" severity="success" (click)="emitirNota(nota)"
                pTooltip="Emitir" tooltipPosition="top" styleClass="w-2rem h-2rem" [loading]="estaCarregando(nota.id)"
                [disabled]="estaCarregando(nota.id)" />
              <p-button icon="pi pi-times" [rounded]="true" [text]="true" severity="danger" (click)="recusarNota(nota)"
                pTooltip="Recusar" tooltipPosition="top" styleClass="w-2rem h-2rem" [loading]="estaCarregando(nota.id)"
                [disabled]="estaCarregando(nota.id)" />
            </ng-container>

            <!-- Se já foi aprovada ou recusada, mostra apenas o status -->
            <ng-container *ngIf="nota.status_id !== 1">
              <span class="text-xs text-500"></span>
            </ng-container>
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="9" class="text-center py-6">
          <div class="flex flex-column align-items-center gap-3">
            <i class="pi pi-inbox text-400 text-6xl"></i>
            <span class="text-500 text-lg">Nenhuma nota fiscal encontrada.</span>
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="paginatorleft">
      <div class="text-500">
        Total: {{ notas.length || 0 }} notas
      </div>
    </ng-template>
  </p-table>
</div>