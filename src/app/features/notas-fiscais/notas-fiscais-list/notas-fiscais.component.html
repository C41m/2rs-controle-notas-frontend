<!-- src/app/features/notas-fiscais/notas-fiscais-list/notas-fiscais.component.html -->
<p-toast />

<app-visualizar-nota-usuario-dialog [(visible)]="modalVisualizarUsuarioVisible" [nota]="notaVisualizar">
</app-visualizar-nota-usuario-dialog>


<!-- Header Section -->
<div class="flex align-items-center gap-3 mb-4 p-3">
  <div class="icon-wrapper border-circle p-3 surface-card shadow-1 flex align-items-center justify-content-center">
    <i class="pi pi-receipt text-primary text-5xl"></i>
  </div>
  <div class="flex flex-column">
    <h1 class="m-0 text-5xl font-bold text-900">Notas Fiscais</h1>
    <p class="text-500 mt-1 mb-0">Gerencie sua movimentação</p>
  </div>
</div>

<!-- Loading -->
<div *ngIf="loadingInicial" class="mb-3">
  <p-progressBar mode="indeterminate" [style]="{ height: '6px' }"></p-progressBar>
</div>

<div *ngIf="!loadingInicial">

  <!-- Dashboard -->
  <app-notas-fiscais-dashboard [notas]="notas"></app-notas-fiscais-dashboard>




  <!-- Main Card -->
  <div class="surface-card p-4 border-round-2xl shadow-1">

    <!-- Toolbar -->
    <div class="flex justify-content-between align-items-center mb-4">
      <div class="flex align-items-center gap-2">
        <p-button icon="pi pi-filter-slash" [rounded]="true" [text]="true" (click)="dt.clear()"
          pTooltip="Limpar filtros" tooltipPosition="top" [disabled]="loadingTabela" />

        <p-iconField iconPosition="left">
          <p-inputIcon>
            <i class="pi pi-search"></i>
          </p-inputIcon>
          <input pInputText type="text" (input)="onGlobalFilter($event)" placeholder="Pesquisar notas..."
            class="w-20rem border-round-2xl" />
        </p-iconField>
      </div>

      <p-button label="Emitir Nota Fiscal" icon="pi pi-plus" (click)="abrirModal()" severity="success"
        [disabled]="loadingTabela" />
    </div>

    <!-- Table -->
    <p-table #dt [value]="notas" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[10, 25, 50]"
      [showCurrentPageReport]="true" currentPageReportTemplate="Exibindo {first} a {last} de {totalRecords} registros"
      responsiveLayout="scroll" dataKey="id"
      [globalFilterFields]="['cliente.cpf_cnpj', 'cliente.razao_social', 'valor_total', 'status_id', 'data_criacao']"
      styleClass="p-datatable-sm">

      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="cliente.cpf_cnpj" class="border-bottom-1  p-3" style="width: 16%">
            <div class="flex align-items-center gap-2">
              <i class="pi pi-id-card text-primary"></i>
              <span class="text-900">CPF/CNPJ</span>
              <p-sortIcon field="cliente.cpf_cnpj" />
            </div>
          </th>

          <th pSortableColumn="cliente.razao_social" class="border-bottom-1 p-3" style="width: 24%">
            <div class="flex align-items-center gap-2">
              <i class="pi pi-building text-primary"></i>
              <span class="text-900">Razão Social</span>
              <p-sortIcon field="cliente.razao_social" />
            </div>
          </th>

          <th pSortableColumn="valor_total" class="border-bottom-1  p-1 text-center" style="width: 15%">
            <div class="flex align-items-center gap-2 justify-content-center">
              <i class="pi pi-money-bill text-primary"></i>
              <span class="text-900">Valor</span>
              <p-sortIcon field="valor_total" />
            </div>
          </th>

          <th pSortableColumn="status_id" class="border-bottom-1  p-1 text-center" style="width: 15%">
            <div class="flex align-items-center gap-2 justify-content-center">
              <i class="pi pi-info-circle text-primary"></i>
              <span class="text-900">Status</span>
              <p-sortIcon field="status_id" />
            </div>
          </th>

          <th pSortableColumn="data_criacao" class="border-bottom-1 " style="width: 20%">
            <div class="flex align-items-center gap-2 justify-content-center">
              <i class="pi pi-calendar text-primary"></i>
              <span class="text-900">Solicitação</span>
              <p-sortIcon field="data_criacao" />
            </div>
          </th>

          <th class="border-bottom-1 p-1 text-center" style="width: 10%">
            <div class="flex align-items-center gap-2 justify-content-center">
              <i class="pi pi-cog text-primary"></i>
              <span class="text-900">Ações</span>
            </div>
          </th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-nota>
        <tr class="border-bottom-1  transition-duration-150">
          <td class="p-3">
            <p class="text-900 m-0">
              {{ nota.cliente.cpf_cnpj | maskCpfCnpj }}
            </p>
          </td>

          <td class="p-3">
            <p class="text-900 m-0 truncate" style="max-width: 250px">
              {{ nota.cliente.razao_social || '—' }}
            </p>
          </td>

          <td class="p-3 text-center">
            <p class="text-900 m-0">
              {{ nota.valor_total | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}
            </p>
          </td>

          <td class="p-3 text-center" style="width: 15%;"> <p-tag [value]="getStatusLabel(nota.status_id)"
              [severity]="getStatusSeverity(nota.status_id)" styleClass="block w-full text-center" /> </td>

          <td class="p-3 text-center">
            <p class="text-900 m-0">
              {{ nota.data_criacao | date: 'dd/MM/yyyy - HH:mm' }}
            </p>
          </td>

          <td class="p-3 text-center">
            <div class="flex justify-content-center gap-1">
              <!-- Visualizar: pode ficar habilitado mesmo durante carregamento -->

              <ng-container>
                <p-button icon="pi pi-eye" [rounded]="true" [text]="true" severity="secondary"
                  (click)="visualizarNota(nota)" pTooltip="Visualizar" tooltipPosition="top" styleClass="w-2rem h-2rem"
                  [disabled]="loadingTabela" />

                <p-button *ngIf="nota.status_id === 1 && usuarioLogado?.emite" icon="pi pi-pencil" [rounded]="true"
                  [text]="true" severity="secondary" (click)="editarNota(nota)" pTooltip="Editar" tooltipPosition="top"
                  styleClass="w-2rem h-2rem" [disabled]="loadingTabela" />

                <p-button *ngIf="nota.status_id === 1 && usuarioLogado?.emite" icon="pi pi-trash" [rounded]="true"
                  [text]="true" severity="danger" (click)="excluirNota(nota)" pTooltip="Cancelar" tooltipPosition="top"
                  styleClass="w-2rem h-2rem" [disabled]="loadingTabela" />

                <p-button *ngIf="nota.status_id === 1 && usuarioLogado?.emite === true" icon="pi pi-file"
                  [rounded]="true" [text]="true" severity="success" (click)="emitirNota(nota)"
                  pTooltip="Emitir Nota Fiscal" tooltipPosition="top" styleClass="w-2rem h-2rem"
                  [disabled]="loadingTabela" />
              </ng-container>
            </div>
          </td>

        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="6" class="text-center py-6" *ngIf="!loadingInicial && !loadingTabela">
            <div class="flex flex-column align-items-center gap-3">
              <i class="pi pi-inbox text-400 text-6xl"></i>
              <span class="text-500 text-lg">Nenhuma nota fiscal encontrada.</span>
              <p-button label="Emitir Primeira Nota" icon="pi pi-plus" (click)="abrirModal()" severity="success"
                [outlined]="true" />
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="paginatorleft">
        <div class="text-500">
          Total: {{ notas.length || 0 }} notas
        </div>
      </ng-template>
    </p-table>
  </div>
</div>


<app-emitir-nota-dialog [(visible)]="modalVisivel" [modo]="modoModal" [notaId]="notaIdParaEdicao || undefined"
  (emitida)="onNotaEmitida()">
</app-emitir-nota-dialog>