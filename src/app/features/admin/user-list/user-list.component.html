<p-toast />
<p-confirmdialog></p-confirmdialog>

<!-- Header Section -->
<div class="flex align-items-center gap-3 mb-4 p-3">
    <div class="icon-wrapper border-circle p-3 surface-card shadow-1 flex align-items-center justify-content-center">
        <i class="pi pi-users text-primary text-5xl"></i>
    </div>
    <div class="flex flex-column">
        <h1 class="m-0 text-5xl font-bold text-900">Usuários</h1>
        <p class="text-500 mt-1 mb-0">Gerencie os usuários do sistema</p>
    </div>
</div>

<!-- Loading -->
<div *ngIf="loadingTabela" class="mb-3">
    <p-progressBar mode="indeterminate" [style]="{ height: '6px' }"></p-progressBar>
</div>

<!-- Main Card -->
<div class="surface-card p-4 border-round-2xl shadow-1">

    <!-- Toolbar -->
    <div class="flex justify-content-between align-items-center mb-4">
        <div class="flex align-items-center gap-2">
            <p-button icon="pi pi-filter-slash" [rounded]="true" [text]="true" (click)="dt.clear()"
                pTooltip="Limpar filtros" tooltipPosition="top" />

            <p-iconField iconPosition="left">
                <p-inputIcon>
                    <i class="pi pi-search"></i>
                </p-inputIcon>
                <input pInputText type="text" (input)="onGlobalFilter($event)" placeholder="Pesquisar usuários..."
                    class="w-20rem border-round-2xl" />
            </p-iconField>
        </div>

        <div class="flex gap-2">
            <p-button label="Atualizar Alíquotas" icon="pi pi-percentage" (click)="atualizarAliquotasEmLote()"
                severity="help" />
            <p-button label="Cadastrar Usuário" icon="pi pi-plus" (click)="abrirModal()" severity="primary" />
        </div>
    </div>

    <!-- Table -->
    <p-table #dt [value]="usuarios" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[10, 25, 50]"
        [showCurrentPageReport]="true" currentPageReportTemplate="Exibindo {first} a {last} de {totalRecords} registros"
        responsiveLayout="scroll" dataKey="id" [globalFilterFields]="['razao_social', 'cnpj_cpf', 'aliquota']"
        styleClass="p-datatable-sm">

        <ng-template pTemplate="header">
            <tr>
                <th pSortableColumn="razao_social" class="border-bottom-1  p-3" style="width: 25%">
                    <div class="flex align-items-center gap-2">
                        <i class="pi pi-building text-primary"></i>
                        <span class="text-900">Razão Social</span>
                        <p-sortIcon field="razao_social" />
                    </div>
                </th>

                <th pSortableColumn="cnpj_cpf" class="border-bottom-1  p-3" style="width: 20%">
                    <div class="flex align-items-center gap-2">
                        <i class="pi pi-id-card text-primary"></i>
                        <span class="text-900">Documento</span>
                        <p-sortIcon field="cnpj_cpf" />
                    </div>
                </th>

                <th pSortableColumn="aliquota" class="border-bottom-1  p-3 text-center" style="width: 15%">
                    <div class="flex align-items-center gap-2 justify-content-center">
                        <i class="pi pi-percentage text-primary"></i>
                        <span class="text-900">Alíquota</span>
                        <p-sortIcon field="aliquota" />
                    </div>
                </th>

                <th class="border-bottom-1  p-3" style="width: 30%">
                    <div class="flex align-items-center gap-2">
                        <i class="pi pi-briefcase text-primary"></i>
                        <span class="text-900">Atividades</span>
                    </div>
                </th>

                <th class="border-bottom-1  p-3 text-center" style="width: 10%">
                    <div class="flex align-items-center gap-2 justify-content-center">
                        <i class="pi pi-cog text-primary"></i>
                        <span class="text-900">Ações</span>
                    </div>
                </th>
            </tr>
        </ng-template>

        <ng-template pTemplate="body" let-user>
            <tr class="border-bottom-1 transition-duration-150">
                <td class="p-3">
                    <p class="text-900 m-0">
                        {{ user.razao_social }}
                    </p>
                </td>

                <td class="p-3">
                    <p class="text-900 m-0">
                        {{ user.cnpj_cpf | maskCpfCnpj }}
                    </p>
                </td>

                <td class="p-3 text-center">
                    <p class="text-900 m-0 font-semibold">
                        {{ user.aliquota ?? 'N/A' }}%
                    </p>
                </td>

                <td class="p-3">
                    <ng-container *ngIf="user.atividades.length > 0; else semAtividade">
                        <div class="flex flex-wrap gap-2">
                            <span *ngFor="let a of user.atividades" pTooltip="{{ a.desc_cnae }}" tooltipPosition="top"
                                class="surface-100 border-round-2xl px-3 py-2 flex align-items-center gap-2 shadow-1 font-bold text-primary">
                                {{ a.cod_cnae }}
                            </span>
                        </div>
                    </ng-container>
                    <ng-template #semAtividade>
                        <span class="text-500">Nenhuma</span>
                    </ng-template>
                </td>

                <td class="p-3 text-center">
                    <div class="flex justify-content-center gap-1">
                        <p-button icon="pi pi-pencil" [rounded]="true" [text]="true" severity="secondary"
                            (click)="editarUsuario(user)" pTooltip="Editar" tooltipPosition="top"
                            styleClass="w-2rem h-2rem" />
                        <p-button icon="pi pi-trash" [rounded]="true" [text]="true" severity="danger"
                            (click)="excluirUsuario(user)" pTooltip="Excluir" tooltipPosition="top"
                            styleClass="w-2rem h-2rem" />
                    </div>
                </td>
            </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="5" class="text-center py-6">
                    <div class="flex flex-column align-items-center gap-3">
                        <i class="pi pi-inbox text-400 text-6xl"></i>
                        <span class="text-500 text-lg">Nenhum usuário encontrado.</span>
                        <p-button label="Cadastrar Primeiro Usuário" icon="pi pi-plus" (click)="abrirModal()"
                            severity="primary" [outlined]="true" />
                    </div>
                </td>
            </tr>
        </ng-template>

        <ng-template pTemplate="paginatorleft">
            <div class="text-500">
                Total: {{ usuarios.length || 0 }} usuários
            </div>
        </ng-template>
    </p-table>
</div>

<!-- Modal de Cadastro -->
<p-dialog [(visible)]="exibirModal" [modal]="true" [draggable]="false" [resizable]="false"
    [header]="usuarioEmEdicao ? 'Editar Usuário' : 'Cadastrar Novo Usuário'" (onHide)="onCancelar()"
    styleClass="w-8">
    <app-user-form [usuarioInicial]="usuarioEmEdicao" (salvar)="onSalvar($event)" (cancelar)="onCancelar()">
    </app-user-form>
</p-dialog>